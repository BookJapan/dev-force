<?php
/* @var $this DevForce */
//$this->mark();
//$this->d($record[0]);
?>
<?php print $description; ?>
<?php if(isset($record[0])): ?>
<table border=1>
	<tr>
		<?php foreach( $columu_struct as $struct ): ?>
			<?php
			if(!empty($struct['hidden'])){ continue; }
			$label	 = $struct['label'];
			$column	 = $struct['field'];
			$type	 = $struct['type'];
			$length	 = isset($struct['length']) ? $struct['length']: null;
			?>
			<th type="<?php print $type ?>" lengty="<?php print $length ?>" column="<?php print $column ?>">
				<?php print $label ?>
			</th>
		<?php endforeach; ?>
	</tr>
<?php foreach( $record as $index => $columns ): ?>
	<tr pvar="<?php print $columns[$pkey] ?>">
		<?php foreach( $columns as $column_name => $value ): ?>
			<?php if(!empty($columu_struct[$column_name]['hidden'])){ continue; } ?>
			<td class="edit" column="<?php print $column_name ?>">
				<span class="value"><?php print $value ?></span>
			</td>
		<?php endforeach; ?>
	</tr>
<?php endforeach; ?>
</table> 
<?php endif; ?>

<script type="text/javascript" src="<?php print $this->ConvertURL('app:/js/jquery-1.11.0.min.js') ?>"></script>
<script>
jQuery(function($) {
	$(".edit").click(function(event){
		//	hide
		$(this).children(".value").hide();

		//	input
		if( $(this).children(".input").size() ){
			//	exists
			$(this).children(".input").show().focus();
			return;
		}else{
			//	init input
			var $input = $("<input />");
			$input.addClass("input");
			$input.val( $(this).children(".value").html() );
			$(this).append($input);
			$input.focus();
		}
		
		$input.blur(function(event){
			//	init
			var pvar   = $(this).parent().parent().attr('pvar');
			var column = $(this).parent().attr('column');
			var value  = $(this).val();
			var page   = '<?php print $page ?>';
			
			//	compare
			if( $(this).val() != $(this).parent().children(".value").html() ){
				
				//	init post data
				var data = {page: page, id: pvar, column: column, value: value};
				
				//	ajax
				$.ajax({
					type: "GET",
					url: "<?php print $this->ConvertURL('app:/ajax') ?>", 
					context: $(this), 
					data: data,
					success: function(result){
						json = $.parseJSON(result);
						//	LOGOUT
						if(json.status == 'LOGOUT'){
							location.reload();
						}	
						//	ERROR
						if(json.error){
							alert(json.error);
							return;
						}
						//	OK
						$(this).parent().children(".value").html(json.value);
						$(this).val(json.value);
					}
				});
			}
			
		//	$(this).remove();
			$(this).hide();
			$(this).parent().children(".value").show();
		});
	});
});
</script>
